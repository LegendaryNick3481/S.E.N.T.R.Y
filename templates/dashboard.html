<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.E.N.T.R.Y - Trading Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom Styles -->
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: #0a0a0a;
            color: #ffffff;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            border-color: rgba(59, 130, 246, 0.4);
        }
        
        .positive {
            color: #10b981;
        }
        
        .negative {
            color: #ef4444;
        }
        
        .neutral {
            color: #6b7280;
        }
        
        .sidebar {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-item {
            transition: all 0.2s ease;
            border-radius: 8px;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .nav-item.active {
            background: rgba(59, 130, 246, 0.2);
            border-left: 3px solid #3b82f6;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-connected {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        .status-disconnected {
            background: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        
        .signal-high {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
        }
        
        .signal-medium {
            background: rgba(245, 158, 11, 0.1);
            border-left: 3px solid #f59e0b;
        }
        
        .signal-low {
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid #10b981;
        }
        
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="bg-black text-white">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 p-6 flex flex-col">
            <!-- Logo -->
            <div class="flex items-center mb-8">
                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center mr-3">
                    <span class="text-white font-bold text-sm">S</span>
                </div>
                <span class="text-xl font-bold">S.E.N.T.R.Y</span>
            </div>
            
            <!-- Navigation -->
            <nav class="flex-1">
                <div class="nav-item active p-3 mb-2 cursor-pointer">
                    <div class="flex items-center">
                        <span class="mr-3">üìä</span>
                        <span>Dashboard</span>
                    </div>
                </div>
                <div class="nav-item p-3 mb-2 cursor-pointer">
                    <div class="flex items-center">
                        <span class="mr-3">üíπ</span>
                        <span>Trading</span>
                    </div>
                </div>
                <div class="nav-item p-3 mb-2 cursor-pointer">
                    <div class="flex items-center">
                        <span class="mr-3">üìà</span>
                        <span>Analytics</span>
                    </div>
                </div>
                <div class="nav-item p-3 mb-2 cursor-pointer">
                    <div class="flex items-center">
                        <span class="mr-3">‚öôÔ∏è</span>
                        <span>Settings</span>
                    </div>
                </div>
            </nav>
            
            <!-- System Status -->
            <div class="mt-auto">
                <div class="glass-card p-4">
                    <div class="text-sm text-gray-400 mb-2">System Status</div>
                    <div class="flex items-center mb-2">
                        <span class="status-indicator status-disconnected"></span>
                        <span class="text-sm">FYERS API</span>
                    </div>
                    <div class="flex items-center mb-2">
                        <span class="status-indicator status-connected"></span>
                        <span class="text-sm">News Feed</span>
                    </div>
                    <div class="flex items-center">
                        <span class="status-indicator status-connected"></span>
                        <span class="text-sm">Analysis Engine</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="p-6 border-b border-gray-800">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold">Trading Dashboard</h1>
                        <p class="text-gray-400 text-sm">Real-time market analysis and trading signals</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="refreshBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium transition-colors">
                            <span class="mr-2">üîÑ</span>
                            Refresh
                        </button>
                        <button id="runCycleBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm font-medium transition-colors">
                            <span class="mr-2">‚ñ∂Ô∏è</span>
                            Run Cycle
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Content -->
            <div class="flex-1 p-6 overflow-y-auto scrollbar-hide">
                <!-- Key Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="glass-card metric-card p-6 fade-in">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-400 text-sm">Portfolio Value</span>
                            <div class="loading-spinner" id="portfolioSpinner"></div>
                        </div>
                        <div id="portfolioValue" class="text-2xl font-bold">-</div>
                        <div id="portfolioChange" class="text-sm mt-1">-</div>
                    </div>
                    
                    <div class="glass-card metric-card p-6 fade-in">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-400 text-sm">Active Positions</span>
                            <div class="loading-spinner" id="positionsSpinner"></div>
                        </div>
                        <div id="activePositions" class="text-2xl font-bold">-</div>
                        <div id="positionsPnl" class="text-sm mt-1">-</div>
                    </div>
                    
                    <div class="glass-card metric-card p-6 fade-in">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-400 text-sm">Discord Score</span>
                            <div class="loading-spinner" id="discordSpinner"></div>
                        </div>
                        <div id="avgDiscordScore" class="text-2xl font-bold">-</div>
                        <div id="discordTrend" class="text-sm mt-1">-</div>
                    </div>
                    
                    <div class="glass-card metric-card p-6 fade-in">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-400 text-sm">Win Rate</span>
                            <div class="loading-spinner" id="winrateSpinner"></div>
                        </div>
                        <div id="winRate" class="text-2xl font-bold">-</div>
                        <div id="totalTrades" class="text-sm mt-1">-</div>
                    </div>
                </div>
                
                <!-- Main Content Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Trading Signals -->
                    <div class="lg:col-span-2">
                        <div class="glass-card p-6 fade-in">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-xl font-bold">Trading Signals</h2>
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-gray-400">Live</span>
                                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                </div>
                            </div>
                            
                            <div class="space-y-3 max-h-96 overflow-y-auto scrollbar-hide">
                                <div id="signalsList">
                                    <div class="text-center py-8 text-gray-400">
                                        <div class="loading-spinner mx-auto mb-2"></div>
                                        Loading signals...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Portfolio & Performance -->
                    <div class="space-y-6">
                        <!-- Portfolio Summary -->
                        <div class="glass-card p-6 fade-in">
                            <h3 class="text-lg font-bold mb-4">Portfolio Summary</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Total Value</span>
                                    <span id="totalValue">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Available Cash</span>
                                    <span id="availableCash">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Exposure</span>
                                    <span id="exposure">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Last Updated</span>
                                    <span id="lastUpdated">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Performance Chart -->
                        <div class="glass-card p-6 fade-in">
                            <h3 class="text-lg font-bold mb-4">Performance</h3>
                            <canvas id="performanceChart" class="w-full h-48"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- News & Analysis -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                    <!-- News Feed -->
                    <div class="glass-card p-6 fade-in">
                        <h3 class="text-lg font-bold mb-4">Latest News</h3>
                        <div class="space-y-4 max-h-96 overflow-y-auto scrollbar-hide">
                            <div id="newsList">
                                <div class="text-center py-8 text-gray-400">
                                    <div class="loading-spinner mx-auto mb-2"></div>
                                    Loading news...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Market Overview -->
                    <div class="glass-card p-6 fade-in">
                        <h3 class="text-lg font-bold mb-4">Market Overview</h3>
                        <div class="space-y-3 max-h-96 overflow-y-auto scrollbar-hide">
                            <div id="marketOverview">
                                <div class="text-center py-8 text-gray-400">
                                    <div class="loading-spinner mx-auto mb-2"></div>
                                    Loading market data...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Utility functions
        const formatCurrency = (amount) => {
            if (typeof amount !== 'number') return '-';
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        };

        const formatPercent = (value) => {
            if (typeof value !== 'number') return '-';
            return `${value >= 0 ? '+' : ''}${value.toFixed(2)}%`;
        };

        const getSignalClass = (discordScore) => {
            if (discordScore > 0.3) return 'signal-high';
            if (discordScore > 0.1) return 'signal-medium';
            return 'signal-low';
        };

        const getSentimentClass = (sentiment) => {
            if (sentiment > 0.1) return 'positive';
            if (sentiment < -0.1) return 'negative';
            return 'neutral';
        };

        // API functions
        async function fetchData(endpoint) {
            try {
                const response = await fetch(endpoint);
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                return null;
            }
        }

        // Render functions
        function renderSignals(signals) {
            const container = document.getElementById('signalsList');
            if (!signals || signals.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400">No signals available</div>';
                return;
            }

            const signalsHtml = signals.slice(0, 10).map(signal => `
                <div class="glass-card p-4 ${getSignalClass(signal.discord_score)} fade-in">
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-bold text-lg">${signal.symbol}</div>
                        <div class="text-sm text-gray-400">${signal.timestamp || ''}</div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div>
                            <div class="text-gray-400">Discord</div>
                            <div class="font-medium">${(signal.discord_score || 0).toFixed(3)}</div>
                        </div>
                        <div>
                            <div class="text-gray-400">Confidence</div>
                            <div class="font-medium">${(signal.confidence || 0).toFixed(2)}</div>
                        </div>
                        <div>
                            <div class="text-gray-400">Price</div>
                            <div class="font-medium">${formatCurrency(signal.current_price)}</div>
                        </div>
                    </div>
                    <div class="mt-2 text-sm">
                        <span class="text-gray-400">Sentiment:</span>
                        <span class="${getSentimentClass(signal.sentiment)}">${formatPercent((signal.sentiment || 0) * 100)}</span>
                    </div>
                </div>
            `).join('');

            container.innerHTML = signalsHtml;
        }

        function renderNews(newsData) {
            const container = document.getElementById('newsList');
            if (!newsData || Object.keys(newsData).length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400">No news available</div>';
                return;
            }

            let newsHtml = '';
            Object.entries(newsData).forEach(([symbol, news]) => {
                if (news && news.length > 0) {
                    news.forEach(article => {
                        newsHtml += `
                            <div class="glass-card p-4 fade-in">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-medium text-blue-400">${symbol}</div>
                                    <div class="text-xs text-gray-400">${article.timestamp || ''}</div>
                                </div>
                                <div class="text-sm mb-2">${article.headline || article.title || 'News update'}</div>
                                <div class="flex items-center justify-between">
                                    <div class="text-xs text-gray-400">${article.source || 'Unknown'}</div>
                                    <div class="text-xs ${getSentimentClass(article.sentiment)}">
                                        ${formatPercent((article.sentiment || 0) * 100)}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
            });

            if (!newsHtml) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400">No news available</div>';
            } else {
                container.innerHTML = newsHtml;
            }
        }

        function renderMarketOverview(overview) {
            const container = document.getElementById('marketOverview');
            if (!overview || !overview.symbols || Object.keys(overview.symbols).length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400">No market data available</div>';
                return;
            }

            const overviewHtml = Object.entries(overview.symbols).slice(0, 10).map(([symbol, data]) => {
                const discordScore = data?.mismatch_analysis?.discord_score || 0;
                const sentiment = data?.sentiment_summary?.weighted_sentiment || 0;
                
                return `
                    <div class="glass-card p-3 fade-in">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-medium">${symbol}</div>
                            <div class="text-xs text-gray-400">${data?.timestamp || ''}</div>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <div>
                                <span class="text-gray-400">Discord:</span>
                                <span class="${getSignalClass(discordScore)}">${discordScore.toFixed(3)}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Sentiment:</span>
                                <span class="${getSentimentClass(sentiment)}">${formatPercent(sentiment * 100)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = overviewHtml;
        }

        function renderPortfolio(portfolio) {
            if (!portfolio) return;

            document.getElementById('totalValue').textContent = formatCurrency(portfolio.portfolio_value || 0);
            document.getElementById('availableCash').textContent = formatCurrency(portfolio.available_cash || 0);
            document.getElementById('exposure').textContent = formatPercent((portfolio.exposure || 0) * 100);
            document.getElementById('lastUpdated').textContent = portfolio.timestamp || '-';
            
            document.getElementById('activePositions').textContent = Object.keys(portfolio.positions || {}).length;
            
            const totalPnl = Object.values(portfolio.positions || {}).reduce((sum, pos) => sum + (pos.pnl || 0), 0);
            document.getElementById('positionsPnl').textContent = formatCurrency(totalPnl);
        }

        function renderMetrics(overview) {
            if (!overview) return;

            document.getElementById('portfolioValue').textContent = formatCurrency(overview.portfolio_value || 0);
            document.getElementById('avgDiscordScore').textContent = (overview.market_summary?.avg_discord_score || 0).toFixed(3);
            document.getElementById('winRate').textContent = formatPercent((overview.win_rate || 0) * 100);
            document.getElementById('totalTrades').textContent = `${overview.total_trades || 0} trades`;
        }

        function hideSpinners() {
            document.querySelectorAll('.loading-spinner').forEach(spinner => {
                spinner.style.display = 'none';
            });
        }

        // Chart initialization
        let performanceChart;
        function initChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Portfolio Value',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#9ca3af' }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { 
                                color: '#9ca3af',
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Main refresh function
        async function refreshAll() {
            try {
                const [overview, signals, portfolio] = await Promise.all([
                    fetchData('/api/overview'),
                    fetchData('/api/signals'),
                    fetchData('/api/portfolio')
                ]);

                renderSignals(signals?.signals || []);
                renderNews(overview?.news_data || {});
                renderMarketOverview(overview || {});
                renderPortfolio(portfolio?.portfolio || {});
                renderMetrics(overview || {});

                hideSpinners();
            } catch (error) {
                console.error('Refresh error:', error);
                hideSpinners();
            }
        }

        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', refreshAll);
        
        document.getElementById('runCycleBtn').addEventListener('click', async () => {
            try {
                const btn = document.getElementById('runCycleBtn');
                btn.innerHTML = '<span class="mr-2">‚è≥</span>Running...';
                btn.disabled = true;
                
                await fetch('/api/run-cycle', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' } 
                });
                
                setTimeout(() => {
                    btn.innerHTML = '<span class="mr-2">‚ñ∂Ô∏è</span>Run Cycle';
                    btn.disabled = false;
                    refreshAll();
                }, 2000);
            } catch (error) {
                console.error('Run cycle error:', error);
                document.getElementById('runCycleBtn').innerHTML = '<span class="mr-2">‚ñ∂Ô∏è</span>Run Cycle';
                document.getElementById('runCycleBtn').disabled = false;
            }
        });

        // Initialize
        initChart();
        refreshAll();
        
        // Auto-refresh every 30 seconds
        setInterval(refreshAll, 30000);
    </script>
</body>
</html>